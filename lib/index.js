!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("SuperFlow",[],e):"object"==typeof exports?exports.SuperFlow=e():t.SuperFlow=e()}("undefined"!=typeof self?self:this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){},function(t,e,n){"use strict";n.r(e);n(0);function i(t){var e=t.clientX,n=t.clientY,i=t.currentTarget.getBoundingClientRect();return{x:e-i.left,y:n-i.top}}function o(t){return t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,!1}var r,s=function(t,e){return[t[0]+e[0],t[1]+e[1]]},a=function(t,e){return[t[0]*e,t[1]*e]},u=function(t,e){return[e[0]-t[0],e[1]-t[1]]},h=function(t,e){return t[0]*e[0]+t[1]*e[1]},l=function(t){return Math.round(180/Math.PI*Math.atan2(t[1],t[0]))+180};function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var f="super-flow",d=Object.freeze({top:1,right:2,bottom:3,left:4}),p=Object.freeze((c(r={},d.top,(function(){return[0,-1]})),c(r,d.right,(function(){return[1,0]})),c(r,d.bottom,(function(){return[0,1]})),c(r,d.left,(function(){return[-1,0]})),r));function v(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var m=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var n=e.id,i=void 0===n?function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=e.length,i=[],o=12,r=0;r<o;r++)i[r]=e[0|Math.random()*n];return t+i.join("")}(t.prefixId):n,o=e.width,r=void 0===o?180:o,s=e.height,a=void 0===s?100:s,u=e.x,h=void 0===u?0:u,l=e.y,c=void 0===l?0:l,f=e.meta,d=void 0===f?null:f;this.id=i,this.width=r,this.height=a,this.x=h,this.y=c,this.meta=d}var e,n,i;return e=t,(n=[{key:"pointDirectionVector",value:function(t,e){var n=l(u(this.center,[t,e]));return n>=this.topLeftAngle&&n<this.topRightAngle?p[d.top]():n>=this.topRightAngle&&n<this.bottomRightAngle?p[d.right]():n>=this.bottomRightAngle&&n<this.bottomLeftAngle?p[d.bottom]():n>=this.bottomLeftAngle||n<this.topLeftAngle?p[d.left]():void 0}},{key:"getEndAt",value:function(t){switch(t.direction=this.pointDirectionVector(this.x+t.x,this.y+t.y),d.toString()){case"0,-1":t.y=0;break;case"1,0":t.x=this.width;break;case"0,1":t.y=this.height;break;case"-1,0":t.x=0}return t}},{key:"center",get:function(){return[this.x+this.width/2,this.y+this.height/2]}},{key:"topLeftAngle",get:function(){return l(u(this.center,[this.x,this.y]))}},{key:"topRightAngle",get:function(){return l(u(this.center,[this.x+this.width,this.y]))}},{key:"bottomRightAngle",get:function(){return l(u(this.center,[this.x+this.width,this.y+this.height]))}},{key:"bottomLeftAngle",get:function(){return l(u(this.center,[this.x,this.y+this.height]))}}])&&v(e.prototype,n),i&&v(e,i),t}();m.prefixId="";var y=m;function b(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var g=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var n=e.start,i=e.end,o=void 0===i?null:i,r=e.startAt,s=void 0===r?{x:0,y:0,direction:d.top}:r,a=e.endAt,u=void 0===a?{x:0,y:0,direction:d.top}:a;this.start=n,this.end=o,this.startAt=s,this.endAt=u,this.moveInfo={x:0,y:0}}var e,n,i;return e=t,(n=[{key:"coordinateList",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=this.startCoordinate,i=this.endCoordinate,o=this.startAt.direction,r=this.endDirectionVector,u=s(n,a(o,t.distance)),l=s(i,a(r,t.distance));r=a(r,-1);var c=[l[0]-u[0],0],f=[0,l[1]-u[1]],d=this.pathDirection(f,c,o),p=this.pathDirection(f,c,r),v=h(d,p)>0?2:1,m=p===c?f:c,y=[];if(y.push(n,u),1===v){var b=s(u,d),g=s(b,p);y.push(b,g)}else{var x=s(u,a(d,e)),w=s(x,m),M=s(w,a(p,1-e));y.push(x,w,M)}return y.push(i),y}},{key:"pathDirection",value:function(t,e,n){return o=n,(i=e)[0]*o[1]-i[1]*o[0]==0?h(e,n)>0?e:t:h(t,n)>0?t:e;var i,o}},{key:"end",get:function(){return this._end},set:function(t){if(this.start===t)return!1;this._end=t}},{key:"pathPointList",get:function(){return this.coordinateList()}},{key:"startCoordinate",get:function(){return[this.start.x+this.startAt.x,this.start.y+this.startAt.y]}},{key:"endCoordinate",get:function(){return this.end?[this.end.x+this.endAt.x,this.end.y+this.endAt.y]:[this.moveInfo.x,this.moveInfo.y]}},{key:"endDirectionVector",get:function(){return this.end?this.endAt.direction:a(this.start.pointDirectionVector(this.moveInfo.x,this.moveInfo.y),-1)}}])&&b(e.prototype,n),i&&b(e,i),t}();g.distance=30;var x=g;function w(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var M=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.nodeList=[],this.relationList=[],this.init(e)}var e,n,i;return e=t,(n=[{key:"nodeMap",value:function(){var t={};return this.nodeList.forEach((function(e){t[e.id]=e})),t}},{key:"relationMap",value:function(){var t={};return this.relationList.forEach((function(e){t[e.id]=e})),t}},{key:"appendNode",value:function(t){var e=t.constructor===y?t:this.createNode(t);this.nodeList.push(e)}},{key:"appendRelation",value:function(t){var e=t.constructor===x?t:this.createRelation(t),n=function(t,e){if(Array.prototype.find)return t.find(e);for(var n=0;n<t.length;n++)if(e(t[n],n))return t[n]}(this.relationList,(function(t){return t.start===e.start&&t.end===e.end}));n?(n.startAt=e.startAt,n.endAt=e.endAt):this.relationList.push(e)}},{key:"createNode",value:function(t){return new y(t)}},{key:"createRelation",value:function(t){return new x(t)}},{key:"init",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.nodeList,i=e.relationList;n.forEach((function(e){t.nodeList.push(t.createNode(e))}));var o=this.nodeMap();i.forEach((function(e){var n=e.startId,i=void 0===n?"":n,r=e.endId,s=void 0===r?"":r,a=e.label,u=void 0===a?null:a,h=e.startAt,l=void 0===h?[]:h,c=e.endAt,f=void 0===c?[]:c,d=o[i],p=o[s];d&&p&&t.relationList.push(t.createRelation({start:d,end:p,label:u,startAt:{x:l[0],y:l[1]},endAt:{x:f[0],y:f[1]}}))}))}}])&&w(e.prototype,n),i&&w(e,i),t}(),L={props:{width:{type:Number,default:0},height:{type:Number,default:0},x:{type:Number,default:0},y:{type:Number,default:0}},methods:{mousedown:function(t){this.$emit("nodeMouseDown",i(t)),o(t)},nodeFocus:function(){this.$emit("nodeFocus")},contextmenu:function(t){o(t)},mouseenter:function(t){this.$emit("nodeMouseEnter",i(t))},mouseleave:function(t){this.$emit("nodeMouseLeave")},mouseup:function(t){this.$emit("nodeMouseup")},sideMousedown:function(t,e){var n=i(t);switch(n.direction=p[e](),e){case d.top:n.y=0;break;case d.right:n.x=this.width;break;case d.bottom:n.y=this.height;break;case d.left:n.x=0}this.$emit("nodeSideMousedown",n),o(t)}},render:function(t){var e=this;return t("div",{staticClass:f+"__node",attrs:{tabindex:-1},style:{width:this.width+"px",height:this.height+"px",top:this.y+"px",left:this.x+"px"},on:{mousedown:this.mousedown,focus:this.nodeFocus,contextmenu:this.contextmenu,mouseenter:this.mouseenter,mouseleave:this.mouseleave,mouseup:this.mouseup}},[this.$slots.default,Object.keys(d).map((function(n){return t("div",{staticClass:"node-side node-side-".concat(n),on:{mousedown:function(t){return e.sideMousedown(t,d[n])}}})}))])}};function A(t){return function(t){if(Array.isArray(t))return C(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return C(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return C(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var k={props:{pointList:{type:Array,default:function(){return[]}},padding:{type:Number,default:20}},data:function(){return{top:0,right:0,bottom:0,left:0,inPath:!1}},mounted:function(){this.ctx=this.$el.getContext("2d"),this.draw()},beforeDestroy:function(){},methods:{draw:function(){var t=this,e=this.pointList.map((function(t){return t[0]})),n=this.pointList.map((function(t){return t[1]}));this.top=Math.min.apply(Math,A(n))-this.padding,this.right=Math.max.apply(Math,A(e))+this.padding,this.bottom=Math.max.apply(Math,A(n))+this.padding,this.left=Math.min.apply(Math,A(e))-this.padding,this.pointList.forEach((function(e){e[0]=Math.floor(e[0]-t.left),e[1]=Math.floor(e[1]-t.top)})),this.changeStyle(),this.drawLine(),this.drawArrow(),this.drawLine(10,"rgba(0,0,0,0)")},changeStyle:function(){this.$el.width=this.right-this.left,this.$el.height=this.bottom-this.top,this.$el.style.top=this.top+"px",this.$el.style.left=this.left+"px"},drawLine:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#666666",n=this.ctx;n.beginPath(),n.lineWidth=t,n.strokeStyle=e,this.pointList.forEach((function(t,e){0===e?n.moveTo.apply(n,A(t)):(n.lineTo.apply(n,A(t)),n.stroke())})),n.save()},drawArrow:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#666666",n=this.pointList.length;if(!(n<2)){var i=this.pointList[n-2],o=this.pointList[n-1],r=this.ctx;r.translate.apply(r,A(o));var s=Math.atan((o[0]-i[0])/(o[1]-i[1]));r.beginPath(),o[1]-i[1]>=0?r.rotate(-s):r.rotate(Math.PI-s),r.fillStyle=e,r.lineTo(-t,2*-t),r.lineTo(0,-t),r.lineTo(t,2*-t),r.lineTo(0,0),r.closePath(),r.fill(),r.restore()}},getCoordinates:function(t){var e=t.clientX,n=t.clientY,i=this.$el.getBoundingClientRect(),o=i.top;return[e-i.left,n-o]}},watch:{pointList:function(){this.draw()}},render:function(t){return t("canvas",{staticClass:f+"__line",class:{inPath:this.inPath}})}},S={props:{visible:{type:Boolean,default:!1},menuList:{type:Array,default:function(){return[]}},x:{type:Number,default:0},y:{type:Number,default:0}},computed:{position:function(){}},methods:{renderItem:function(t){var e=this,n=[];return this.menuList.forEach((function(i){i.forEach((function(i){n.push(t("li",{staticClass:f+"__menu-item",on:{mousedown:function(){i.isHandler?e.$emit("handler",i):e.$emit("item-click",{meta:i,x:e.x,y:e.y,width:i.width,height:i.height}),e.$emit("update:visible",!1)}}},e.$slots.default||[t("span",{staticClass:f+"__menu-item-icon"}),t("span",{staticClass:f+"__menu-item-content"},i.label)]))})),n.push(t("li",{staticClass:f+"__menu-line"}))})),n}},watch:{visible:function(){var t=this;this.visible&&this.$nextTick((function(){return t.$el.focus()}))}},render:function(t){var e=this;return t("ul",{staticClass:f+"__menu",attrs:{tabindex:"-1"},on:{blur:function(){e.visible&&e.$emit("update:visible",!1)}},style:{display:this.visible?"block":"none",top:this.y+"px",left:this.x+"px"}},this.renderItem(t))}};function $(t){return function(t){if(Array.isArray(t))return j(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return j(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return j(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function j(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}e.default={props:{nodeProto:{type:Array,default:function(){return[{type:"start",label:"开始节点"},{type:"end",label:"结束节点"}]}},nodeList:{type:Array,default:function(){return[]}},relationList:{type:Array,default:function(){return[]}},menuList:{type:Array,default:function(){return[[]]}}},data:function(){var t=this;return{moveNodeConf:{isDown:!1,offset:{x:0,y:0},node:null,reset:function(){t.moveNodeConf.isDown=!1}},menuConf:{list:[this.nodeProto,[{label:"竖向对齐",type:"",isHandler:!0},{label:"横向对齐",type:"",isHandler:!0}]],visible:!1,x:0,y:0},temRelationConf:{isMove:!1,visible:!1,relation:null,reset:function(){var e=t.temRelationConf;e.isMove=!1,e.visible=!1,e.relation=null}},graph:new M({nodeList:this.nodeList,relationList:this.relationList}),mousemoveFun:function(){return null}}},mounted:function(){document.addEventListener("mouseup",this.docMouseup),this.$nextTick(this.scrollBy)},beforeDestroy:function(){document.removeEventListener("mouseup",this.docMouseup)},methods:{scrollBy:function(){if(this.$el){var t=this.$el,e=t.clientHeight,n=t.clientWidth,i=t.scrollHeight,o=t.scrollWidth;this.$el.scrollTop=Math.ceil((i-e)/2),this.$el.scrollLeft=Math.ceil((o-n)/2)}},menuOpen:function(t){var e=i(t),n=e.x,r=e.y;this.menuConf.visible=!0,this.menuConf.x=n,this.menuConf.y=r,o(t)},docMouseup:function(){this.mousemoveFun=function(){return null},this.moveNodeConf.reset(),this.temRelationConf.reset()},nodeMouseDown:function(t,e,n){var i=this.graph.nodeList,o=this.moveNodeConf;i.splice(i.length-1,0,i.splice(n,1)[0]),o.isDown=!0,o.offset=t,o.node=e,this.mousemoveFun=this.moveNode},nodeMouseEnter:function(t,e){var n=this.temRelationConf;n.isMove&&(n.relation.end=e,n.relation.endAt=e.getEndAt(t))},nodeMouseLeave:function(){var t=this.temRelationConf;t.isMove&&(t.relation.end=null)},nodeMouseup:function(t){var e=this.temRelationConf;e.isMove&&e.relation.start!==t&&this.graph.appendRelation(e.relation)},nodeSideMousedown:function(t,e){var n=this.temRelationConf;n.visible=!0,n.relation=this.graph.createRelation({start:t,startAt:e}),this.mousemoveFun=this.moveRelation},moveNode:function(t){var e=i(t),n=e.x,o=e.y,r=this.moveNodeConf,s=r.node,a=r.offset;s.x=n-a.x,s.y=o-a.y},moveRelation:function(t){var e=i(t),n=e.x,o=e.y,r=this.temRelationConf.relation;this.temRelationConf.isMove=!0,r.moveInfo.x=n,r.moveInfo.y=o},handler:function(t){},renderNode:function(t){var e=this;return this.graph.nodeList.map((function(n,i){return t(L,{props:{x:n.x,y:n.y,width:n.width,height:n.height},class:{isSelect:e.moveNodeConf.node===n},attrs:{"data-node-type":n.meta.type},on:{nodeMouseDown:function(t){return e.nodeMouseDown(t,n,i)},nodeMouseEnter:function(t){return e.nodeMouseEnter(t,n)},nodeMouseLeave:e.nodeMouseLeave,nodeMouseup:function(){return e.nodeMouseup(n)},nodeSideMousedown:function(t){return e.nodeSideMousedown(n,t)}}},e.$scopedSlots.node?e.$scopedSlots.node({node:n}):t("div",{}))}))},renderLine:function(t){var e=this.temRelationConf,n=[t(k,{style:{display:e.isMove?"block":"none"},props:{pointList:e.relation?e.relation.pathPointList:[]}})];return this.graph.relationList.forEach((function(e){n.push(t(k,{props:{pointList:e.pathPointList}}))})),n},renderMenu:function(t){var e=this,n=this.menuConf;return t(S,{props:{visible:n.visible,menuList:n.list,x:n.x,y:n.y},on:{"update:visible":function(t){return e.menuConf.visible=!!t},"item-click":function(t){return e.graph.appendNode(t)},handler:this.handler}})}},render:function(t){return t("div",{staticClass:f},[t("div",{on:{contextmenu:this.menuOpen,mousemove:this.mousemoveFun}},[].concat($(this.renderNode(t)),$(this.renderLine(t)),[this.renderMenu(t)]))])}}}]).default}));