!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("SuperFlow",[],e):"object"==typeof exports?exports.SuperFlow=e():t.SuperFlow=e()}("undefined"!=typeof self?self:this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){},function(t,e,n){"use strict";n.r(e);n(0);function i(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t.clientX,i=t.clientY,o=t.currentTarget,r=e||o,s=r.getBoundingClientRect(),a=s.left,u=s.top;return{x:n-a,y:i-u}}function o(t){return t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,!1}var r,s=function(t,e){return[t[0]+e[0],t[1]+e[1]]},a=function(t,e){return[t[0]*e,t[1]*e]},u=function(t,e){return[e[0]-t[0],e[1]-t[1]]},l=function(t,e){return t[0]*e[0]+t[1]*e[1]},h=function(t){return Math.round(180/Math.PI*Math.atan2(t[1],t[0]))+180};function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var d="super-flow",f=Object.freeze({top:1,right:2,bottom:3,left:4}),p=Object.freeze((c(r={},f.top,[0,-1]),c(r,f.right,[1,0]),c(r,f.bottom,[0,1]),c(r,f.left,[-1,0]),r)),v=Object.freeze({nodeDelete:0,nodeConnection:1,verticalAlign:2,HorizontalAlign:3});function m(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var y=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var n=e.id,i=void 0===n?function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=e.length,i=[],o=12,r=0;r<o;r++)i[r]=e[0|Math.random()*n];return t+i.join("")}(t.prefixId):n,o=e.width,r=void 0===o?180:o,s=e.height,a=void 0===s?100:s,u=e.x,l=void 0===u?0:u,h=e.y,c=void 0===h?0:h,d=e.meta,f=void 0===d?null:d;this.id=i,this.width=r,this.height=a,this.x=l,this.y=c,this.meta=f,this.parent=null,this.angle()}var e,n,i;return e=t,(n=[{key:"angle",value:function(){var t=this.center,e=this.x,n=this.y,i=this.width,o=this.height;this.topLeftAngle=h(u(t,[e,n])),this.topRightAngle=h(u(t,s([e,n],[i,0]))),this.bottomRightAngle=h(u(t,s([e,n],[i,o]))),this.bottomLeftAngle=h(u(t,s([e,n],[0,o])))}},{key:"pointDirection",value:function(t,e){var n=h(u(this.center,[t,e]));return n>=this.topLeftAngle&&n<this.topRightAngle?f.top:n>=this.topRightAngle&&n<this.bottomRightAngle?f.right:n>=this.bottomRightAngle&&n<this.bottomLeftAngle?f.bottom:n>=this.bottomLeftAngle||n<this.topLeftAngle?f.left:void 0}},{key:"getEndAt",value:function(t){var e=this.pointDirection(this.x+t.x,this.y+t.y);switch(t.direction=p[e],e){case f.top:t.y=0;break;case f.right:t.x=this.width;break;case f.bottom:t.y=this.height;break;case f.left:t.x=0}return t}},{key:"center",get:function(){return[this.x+this.width/2,this.y+this.height/2]}},{key:"width",get:function(){return this._width},set:function(t){this._width=Math.floor(t),this.angle()}},{key:"height",get:function(){return this._height},set:function(t){this._height=Math.floor(t),this.angle()}}])&&m(e.prototype,n),i&&m(e,i),t}();y.prefixId="";var g=y;function b(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var x=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var n=e.start,i=e.end,o=void 0===i?null:i,r=e.startAt,s=void 0===r?{x:0,y:0,direction:f.top}:r,a=e.endAt,u=void 0===a?{x:0,y:0,direction:f.top}:a;e.meta;this.start=n,this.end=o,this.startAt=s,this.endAt=u,this.moveInfo={x:0,y:0},this.meta=null,this.parent=null}var e,n,i;return e=t,(n=[{key:"startCoordinate",value:function(){return[this.start.x+this.startAt.x,this.start.y+this.startAt.y]}},{key:"endCoordinate",value:function(){return this.end?[this.end.x+this.endAt.x,this.end.y+this.endAt.y]:[this.moveInfo.x,this.moveInfo.y]}},{key:"endDirectionVector",value:function(){if(this.end)return this.endAt.direction;var t=this.start.pointDirection(this.moveInfo.x,this.moveInfo.y);return a(p[t],-1)}},{key:"coordinateList",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=this.startCoordinate(),i=this.endCoordinate(),o=this.startAt.direction,r=this.endDirectionVector(),u=s(n,a(o,t.distance)),h=s(i,a(r,t.distance));r=a(r,-1);var c=[h[0]-u[0],0],d=[0,h[1]-u[1]],f=this.pathDirection(d,c,o),p=this.pathDirection(d,c,r),v=l(f,p)>0?2:1,m=p===c?d:c,y=[];if(y.push(n,u),1===v){var g=s(u,f),b=s(g,p);y.push(g,b)}else{var x=s(u,a(f,e)),L=s(x,m),w=s(L,a(p,1-e));y.push(x,L,w)}return y.push(i),y}},{key:"pathDirection",value:function(t,e,n){return o=n,(i=e)[0]*o[1]-i[1]*o[0]==0?l(e,n)>0?e:t:l(t,n)>0?t:e;var i,o}},{key:"end",get:function(){return this._end},set:function(t){if(this.start===t)return!1;this._end=t}},{key:"pathPointList",get:function(){return this.coordinateList()}}])&&b(e.prototype,n),i&&b(e,i),t}();x.distance=15;var L=x;function w(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var A=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.nodeList=[],this.relationList=[],this.init(e)}var e,n,i;return e=t,(n=[{key:"nodeMap",value:function(){var t={};return this.nodeList.forEach((function(e){t[e.id]=e})),t}},{key:"relationMap",value:function(){var t={};return this.relationList.forEach((function(e){t[e.id]=e})),t}},{key:"removeNode",value:function(t){var e=this,n=this.nodeList.indexOf(t);this.relationList.filter((function(e){return e.start===t||e.end===t})).forEach((function(t){e.removeRelation(t)})),this.nodeList.splice(n,1)}},{key:"removeRelation",value:function(t){var e=this.relationList.indexOf(t);this.relationList.splice(e,1)}},{key:"appendNode",value:function(t){var e=t.constructor===g?t:this.createNode(t);this.nodeList.push(e)}},{key:"appendRelation",value:function(t){var e=t.constructor===L?t:this.createRelation(t),n=function(t,e){if(Array.prototype.find)return t.find(e);for(var n=0;n<t.length;n++)if(e(t[n],n))return t[n]}(this.relationList,(function(t){return t.start===e.start&&t.end===e.end}));n?(n.startAt=e.startAt,n.endAt=e.endAt):this.relationList.push(e)}},{key:"createNode",value:function(t){var e=new g(t);return e.parent=this,e}},{key:"createRelation",value:function(t){var e=new L(t);return e.parent=this,e}},{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.nodeList,n=void 0===e?[]:e,i=t.relationList,o=void 0===i?[]:i;this.initNode(n),this.initRelation(o)}},{key:"initNode",value:function(t){var e,n=this,i=[];t.forEach((function(t){i.push(n.createNode(t))})),(e=this.nodeList).splice.apply(e,[0,this.nodeList.length].concat(i))}},{key:"initRelation",value:function(t){var e,n=this,i=[];t.forEach((function(t){var e=t.startId,o=void 0===e?"":e,r=t.endId,s=void 0===r?"":r,a=t.meta,u=void 0===a?null:a,l=t.startAt,h=void 0===l?{x:0,y:0,direction:f.top}:l,c=t.endAt,d=void 0===c?{x:0,y:0,direction:f.top}:c,p=n.nodeMap(),v=p[o],m=p[s];v&&m&&i.push(n.createRelation({start:v,end:m,meta:u,startAt:h,endAt:d}))})),(e=this.relationList).splice.apply(e,[0,this.relationList.length].concat(i))}},{key:"toJson",value:function(){return{nodeList:this.nodeList.map((function(t){return{id:t.id,width:t.width,height:t.height,x:t.x,y:t.y,meta:t.meta}})),relationList:this.relationList.map((function(t){return{startId:t.start.id,endId:t.end.id,meta:t.meta,startAt:t.startAt,endAt:t.endAt}}))}}}])&&w(e.prototype,n),i&&w(e,i),t}(),C={props:{visible:{type:Boolean,default:!1},menuList:{type:Array,default:function(){return[]}},x:{type:Number,default:0},y:{type:Number,default:0}},computed:{position:function(){}},methods:{menuItemClick:function(t){t.isHandler?this.$emit("handler",t):this.$emit("item-click",{meta:t,x:this.x,y:this.y,width:t.width,height:t.height}),this.$emit("update:visible",!1)},renderItem:function(t){var e=this,n=[];return this.menuList.forEach((function(i){i.forEach((function(i){n.push(t("li",{staticClass:d+"__menu-item"},e.$slots.default||[t("span",{staticClass:d+"__menu-item-icon"}),t("span",{staticClass:d+"__menu-item-content"},i.label),t("div",{on:{click:function(){return e.menuItemClick(i)}}})]))})),n.push(t("li",{staticClass:d+"__menu-line"}))})),n}},watch:{visible:function(){var t=this;this.visible&&this.$nextTick((function(){return t.$el.focus()}))}},render:function(t){var e=this;return t("ul",{staticClass:d+"__menu",attrs:{tabindex:"-1"},on:{blur:function(){e.visible&&e.$emit("update:visible",!1)}},style:{display:this.visible?"block":"none",top:this.y+"px",left:this.x+"px"}},this.renderItem(t))}},M={props:{node:Object,index:Number,menuConf:Object,temRelationConf:Object,moveNodeConf:Object},data:function(){return{graph:this.node.parent,nodeMenuList:[[{label:"创建连线",type:v.nodeConnection,isHandler:!0}],[{label:"删除",type:v.nodeDelete,isHandler:!0}]]}},methods:{nodeMousedown:function(t){var e=this.graph.nodeList,n=this.moveNodeConf;e.splice(e.length-1,0,e.splice(this.index,1)[0]),n.isDown=!0,n.offset=i(t),n.node=this.node,this.menuConf.visible=!1,this.$emit("updateMousemoveFun",this.moveNode),o(t)},moveNode:function(t){var e=i(t),n=e.x,o=e.y,r=this.moveNodeConf,s=r.node,a=r.offset;s.x=n-a.x,s.y=o-a.y},moveRelation:function(t){var e=i(t),n=e.x,o=e.y,r=this.temRelationConf.relation;this.temRelationConf.isMove=!0,r.moveInfo.x=n,r.moveInfo.y=o},nodeMouseEnter:function(t){var e=this.temRelationConf;e.isMove&&(e.relation.end=this.node,e.relation.endAt=this.node.getEndAt(i(t)))},nodeMouseLeave:function(){var t=this.temRelationConf;t.isMove&&(t.relation.end=null)},nodeMouseup:function(){var t=this.temRelationConf;t.isMove&&t.relation.start!==this.node&&this.graph.appendRelation(t.relation)},showNodeMenu:function(t){this.menuConf.list=this.nodeMenuList,this.menuConf.data=this.node,this.menuConf.open(t),o(t)},sideMousedown:function(t,e){var n=i(t),r=this.temRelationConf;switch(n.direction=p[e],e){case f.top:n.y=0;break;case f.right:n.x=this.node.width;break;case f.bottom:n.y=this.node.height;break;case f.left:n.x=0}r.visible=!0,r.relation=this.graph.createRelation({start:this.node,startAt:n}),this.$emit("updateMousemoveFun",this.moveRelation),o(t)}},render:function(t){var e=this;return t("div",{staticClass:d+"__node",attrs:{tabindex:-1},style:{width:this.node.width+"px",height:this.node.height+"px",top:this.node.y+"px",left:this.node.x+"px"},on:{mousedown:this.nodeMousedown,contextmenu:this.showNodeMenu,mouseenter:this.nodeMouseEnter,mouseleave:this.nodeMouseLeave,mouseup:this.nodeMouseup}},[this.$slots.default,Object.keys(f).map((function(n){return t("div",{staticClass:"node-side node-side-".concat(n),on:{mousedown:function(t){return e.sideMousedown(t,f[n])}}})}))])}};function k(t){return function(t){if(Array.isArray(t))return R(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return R(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return R(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var j={props:{pointList:{type:Array,default:function(){return[]}},padding:{type:Number,default:20}},data:function(){return{top:0,right:0,bottom:0,left:0,inPath:!1}},mounted:function(){this.ctx=this.$el.getContext("2d"),this.draw()},beforeDestroy:function(){},methods:{draw:function(){var t=this,e=this.pointList.map((function(t){return t[0]})),n=this.pointList.map((function(t){return t[1]}));this.top=Math.min.apply(Math,k(n))-this.padding,this.right=Math.max.apply(Math,k(e))+this.padding,this.bottom=Math.max.apply(Math,k(n))+this.padding,this.left=Math.min.apply(Math,k(e))-this.padding,this.pointList.forEach((function(e){e[0]=Math.floor(e[0]-t.left),e[1]=Math.floor(e[1]-t.top)})),this.changeStyle(),this.drawLine(),this.drawArrow(),this.drawLine(10,"rgba(0,0,0,0)")},changeStyle:function(){this.$el.width=this.right-this.left,this.$el.height=this.bottom-this.top,this.$el.style.top=this.top+"px",this.$el.style.left=this.left+"px"},drawLine:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#666666",n=this.ctx;n.beginPath(),n.lineWidth=t,n.strokeStyle=e,this.pointList.forEach((function(t,e){0===e?n.moveTo.apply(n,k(t)):(n.lineTo.apply(n,k(t)),n.stroke())})),n.save()},drawArrow:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#666666",n=this.pointList.length;if(!(n<2)){var i=this.pointList[n-2],o=this.pointList[n-1],r=this.ctx;r.translate.apply(r,k(o));var s=Math.atan((o[0]-i[0])/(o[1]-i[1]));r.beginPath(),o[1]-i[1]>=0?r.rotate(-s):r.rotate(Math.PI-s),r.fillStyle=e,r.lineTo(-t,2*-t),r.lineTo(0,-t),r.lineTo(t,2*-t),r.lineTo(0,0),r.closePath(),r.fill(),r.restore()}},getCoordinates:function(t){var e=t.clientX,n=t.clientY,i=this.$el.getBoundingClientRect(),o=i.top;return[e-i.left,n-o]}},watch:{pointList:function(){this.draw()}},render:function(t){return t("canvas",{staticClass:d+"__line",class:{inPath:this.inPath}})}};function N(t){return function(t){if(Array.isArray(t))return O(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return O(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function O(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}e.default={props:{nodeProto:{type:Array,default:function(){return[{type:"start",label:"开始节点"},{type:"end",label:"结束节点"}]}},nodeList:{type:Array,default:function(){return[]}},relationList:{type:Array,default:function(){return[]}}},data:function(){var t=this;return{moveNodeConf:{isDown:!1,offset:{x:0,y:0},node:null,reset:function(){t.moveNodeConf.isDown=!1}},pageMenuList:[this.nodeProto,[{label:"竖向对齐",type:v.verticalAlign,isHandler:!0},{label:"横向对齐",type:v.HorizontalAlign,isHandler:!0}]],menuConf:{list:[],visible:!1,data:null,x:0,y:0,open:function(e){var n=i(e,t.$refs["flow-canvas"]),o=n.x,r=n.y;t.menuConf.visible=!0,t.menuConf.x=o,t.menuConf.y=r}},temRelationConf:{isMove:!1,visible:!1,relation:null,reset:function(){var e=t.temRelationConf;e.isMove=!1,e.visible=!1,e.relation=null}},graph:new A({nodeList:this.nodeList,relationList:this.relationList}),mousemoveFun:function(){return null}}},mounted:function(){document.addEventListener("mouseup",this.docMouseup),this.$nextTick(this.scrollBy)},beforeDestroy:function(){document.removeEventListener("mouseup",this.docMouseup)},methods:{scrollBy:function(){if(this.$el){var t=this.$el,e=t.clientHeight,n=t.clientWidth,i=t.scrollHeight,o=t.scrollWidth;this.$el.scrollTop=Math.ceil((i-e)/2),this.$el.scrollLeft=Math.ceil((o-n)/2)}},menuOpen:function(t){this.menuConf.list=this.pageMenuList,this.menuConf.data=null,this.menuConf.open(t),o(t)},docMouseup:function(){this.mousemoveFun=function(){return null},this.moveNodeConf.reset(),this.temRelationConf.reset()},handler:function(t){switch(t.type){case v.verticalAlign:case v.HorizontalAlign:break;case v.nodeDelete:this.graph.removeNode(this.menuConf.data)}},renderNode:function(t){var e=this;return this.graph.nodeList.map((function(n,i){return t(M,{props:{node:n,index:i,menuConf:e.menuConf,temRelationConf:e.temRelationConf,moveNodeConf:e.moveNodeConf},class:{isSelect:e.moveNodeConf.node===n},attrs:{"data-node-type":n.meta.type},on:{updateMousemoveFun:function(t){return e.mousemoveFun=t}}},e.$scopedSlots.node?e.$scopedSlots.node({node:n}):t("div",{}))}))},renderLine:function(t){var e=this.temRelationConf,n=[t(j,{style:{display:e.isMove?"block":"none"},props:{pointList:e.relation?e.relation.pathPointList:[]}})];return this.graph.relationList.forEach((function(e){n.push(t(j,{props:{pointList:e.pathPointList}}))})),n},renderMenu:function(t){var e=this,n=this.menuConf;return t(C,{props:{visible:n.visible,menuList:n.list,x:n.x,y:n.y},on:{"update:visible":function(t){return e.menuConf.visible=!!t},"item-click":function(t){return e.graph.appendNode(t)},handler:this.handler}})},getGraphData:function(){return this.graph.toJson()}},render:function(t){return t("div",{staticClass:d},[t("div",{ref:"flow-canvas",on:{contextmenu:this.menuOpen,mousemove:this.mousemoveFun}},[].concat(N(this.renderNode(t)),N(this.renderLine(t)),[this.renderMenu(t)]))])},watch:{nodeList:function(){this.graph.initNode(this.nodeList)},relationList:function(){this.graph.initRelation(this.relationList)}}}}]).default}));